<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShiftCrafter Part 2 — 月次版（ICS出力つき）MVP</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; color: #0e1d2f; }
    h1 { margin: 0 0 12px; font-size: 22px; }
    .desc { color: #456; margin-bottom: 16px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .panel { border: 1px solid #dde3ea; border-radius: 10px; padding: 12px; background: #f8fafc; }
    .panel h2 { font-size: 16px; margin: 0 0 8px; }
    label { display:block; font-size: 12px; color:#345; margin: 6px 0 4px; }
    input, textarea, select, button { width: 100%; box-sizing: border-box; font-size: 14px; padding: 8px; border: 1px solid #c9d3df; border-radius: 8px; }
    textarea { min-height: 120px; resize: vertical; }
    .row { display:flex; gap: 8px; align-items:center; }
    .row > * { flex: 1; }
    .btn { background:#0ea5a6; color:white; border:none; padding:10px 12px; border-radius: 10px; cursor:pointer; font-weight: 600; }
    .btn.secondary { background:#475569; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    table { width:100%; border-collapse: collapse; font-size: 13px; }
    th, td { border:1px solid #e2e8f0; padding:6px 8px; text-align:left; }
    th { background:#eef2f7; }
    .note { font-size:12px; color:#566; }
    .ok { color:#0a7; font-weight:600; }
    .warn { color:#b45309; font-weight:600; }
    .error { color:#b91c1c; font-weight:600; }
    .footer { margin-top: 16px; font-size: 12px; color:#566; }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,monospace; font-size:12px; }
  </style>
</head>
<body>
  <h1>ShiftCrafter Part 2 — 月次版（ICS出力つき）MVP</h1>
  <p class="desc">二交代（<b>日勤/夜勤</b>）の<b>1か月</b>シフトをブラウザだけで作成。<b>CSV</b>／<b>ICS</b>出力対応。データは外部送信しません。</p>

  <div class="grid">
    <div class="panel">
      <h2>入力</h2>
      <label>対象月（YYYY-MM）</label>
      <input id="month" type="month" />
      <div class="row">
        <div>
          <label>日勤の必要人数（全日共通・最小MVP）</label>
          <input id="needDay" type="number" min="0" value="2" />
        </div>
        <div>
          <label>夜勤の必要人数（全日共通・最小MVP）</label>
          <input id="needNight" type="number" min="0" value="1" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>週あたり夜勤上限（各職員）</label>
          <input id="weeklyNightCap" type="number" min="0" value="2" />
        </div>
        <div>
          <label>月あたり夜勤上限（任意・空なら無制限）</label>
          <input id="monthlyNightCap" type="number" min="0" placeholder="例: 6" />
        </div>
      </div>
      <label>職員リスト（1行1名）</label>
      <textarea id="staffList" placeholder="田中
鈴木
佐藤
…"></textarea>
      <label>休み希望（任意・1行1件）<span class="note">（例）2025-11-03 田中</span></label>
      <textarea id="requests" placeholder="2025-11-03 田中
2025-11-08 鈴木"></textarea>
      <div class="row" style="margin-top:8px;">
        <button class="btn" id="btnGen">シフト自動作成</button>
        <button class="btn secondary" id="btnCsv" disabled>CSVダウンロード</button>
        <button class="btn secondary" id="btnIcsAll" disabled>ICSダウンロード</button>
        <button class="btn secondary" id="btnValidate" disabled>検証CSVダウンロード</button>
      </div>
      <div id="msg" class="note" style="margin-top:8px;"></div>
    </div>

    <div class="panel">
      <h2>結果プレビュー（読み取り専用）</h2>
      <div id="tableWrap" class="mono">未作成</div>
      <div class="footer note">制約（MVP）：Night→翌Day禁止／週あたり夜勤上限／（任意）月あたり夜勤上限／休み希望尊重。公平性最適化は次段で対応。</div>
    </div>
  </div>

  <div class="panel" style="margin-top:16px;">
    <h2>検証サマリ（MVP）</h2>
    <div id="summary" class="mono">—</div>
  </div>

<script>
// ====== ユーティリティ ======
const fmtDate = (d) => d.toISOString().slice(0,10);
function parseMonthStr(ym){ if(!ym) return null; const [y,m]=ym.split('-').map(Number); return new Date(y,m-1,1); }
function daysInMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0).getDate(); }
function addDays(date,n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }
function dowStr(d){ return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()]; }
function isoWeekKey(d){
  const date=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum=(date.getUTCDay()+6)%7; date.setUTCDate(date.getUTCDate()-dayNum+3);
  const firstThursday=new Date(Date.UTC(date.getUTCFullYear(),0,4));
  const week=1+Math.round(((date-firstThursday)/86400000-3+((firstThursday.getUTCDay()+6)%7))/7);
  return `${date.getUTCFullYear()}-W${String(week).padStart(2,'0')}`;
}

// ====== 入力取り出し ======
function getStaff(){ return document.getElementById('staffList').value.split(/\n+/).map(s=>s.trim()).filter(Boolean); }
function getRequests(){
  const m={}; document.getElementById('requests').value.split(/\n+/).forEach(line=>{
    line=line.trim(); if(!line) return; const [date,...rest]=line.split(/\s+/);
    const name=rest.join(' ').trim(); if(!m[date]) m[date]=new Set(); if(name) m[date].add(name);
  }); return m;
}

// ====== 割当アルゴリズム（MVP） ======
function assignMonthly(params){
  const { monthStart, needDay, needNight, weeklyNightCap, monthlyNightCap, staff, requests } = params;
  const days=daysInMonth(monthStart);
  const schedule=[];
  const stats={}; staff.forEach(s=> stats[s]={ total:0, nightMonth:0, nightByWeek:{}, lastShiftByDate:{} });

  for(let i=0;i<days;i++){
    const d=addDays(monthStart,i); const dateStr=fmtDate(d); const weekKey=isoWeekKey(d);
    const dayReq=Number(needDay)||0; const nightReq=Number(needNight)||0;
    const nightAssigned=[]; const dayAssigned=[];
    const isReqOff=(name)=>requests[dateStr]?.has(name);
    const hadNightPrev=(name)=>{ const prev=addDays(d,-1); return stats[name].lastShiftByDate[fmtDate(prev)]==='Night'; };
    const rankForNight=(name)=>{ const st=stats[name]; const wk=st.nightByWeek[weekKey]||0; const m=st.nightMonth; return [m,wk,st.total,name]; };
    const rankForDay=(name)=>{ const st=stats[name]; return [st.total,st.nightMonth,name]; };

    // Night
    for(let k=0;k<nightReq;k++){
      const candidates=staff.filter(name=>{
        if(isReqOff(name)) return false;
        if(nightAssigned.includes(name)) return false;
        if(dayAssigned.includes(name)) return false;
        const wk=stats[name].nightByWeek[weekKey]||0;
        if(weeklyNightCap!=null && weeklyNightCap!=='' && wk>=Number(weeklyNightCap)) return false;
        if(monthlyNightCap!=null && monthlyNightCap!=='' && stats[name].nightMonth>=Number(monthlyNightCap)) return false;
        return true;
      }).sort((a,b)=>{ const ra=rankForNight(a), rb=rankForNight(b); return (ra<rb?-1:ra>rb?1:0); });
      if(candidates.length){
        const pick=candidates[0]; nightAssigned.push(pick);
        stats[pick].total++; stats[pick].nightMonth++; stats[pick].nightByWeek[weekKey]=(stats[pick].nightByWeek[weekKey]||0)+1;
        stats[pick].lastShiftByDate[dateStr]='Night';
      }
    }
    // Day（Night→翌Day禁止）
    for(let k=0;k<dayReq;k++){
      const candidates=staff.filter(name=>{
        if(isReqOff(name)) return false;
        if(nightAssigned.includes(name)) return false;
        if(dayAssigned.includes(name)) return false;
        if(hadNightPrev(name)) return false;
        return true;
      }).sort((a,b)=>{ const ra=rankForDay(a), rb=rankForDay(b); return (ra<rb?-1:ra>rb?1:0); });
      if(candidates.length){
        const pick=candidates[0]; dayAssigned.push(pick);
        stats[pick].total++; stats[pick].lastShiftByDate[dateStr]='Day';
      }
    }
    schedule.push({ date:dateStr, dow:dowStr(d), day:dayAssigned, night:nightAssigned, needDay:dayReq, needNight:nightReq });
  }
  return { schedule };
}

// ====== 出力（CSV/ICS） ======
function download(filename, blob){
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename;
  document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },250);
}
function toCSVWide(schedule){
  let maxDay=0, maxNight=0; schedule.forEach(r=>{ maxDay=Math.max(maxDay,r.day.length); maxNight=Math.max(maxNight,r.night.length); });
  const headers=['date','dow','need_day','need_night']; for(let i=1;i<=maxDay;i++) headers.push(`day_staff_${i}`); for(let i=1;i<=maxNight;i++) headers.push(`night_staff_${i}`);
  const rows=[headers.join(',')];
  schedule.forEach(r=>{
    const row=[r.date,r.dow,r.needDay,r.needNight];
    for(let i=0;i<maxDay;i++) row.push(r.day[i]||''); for(let i=0;i<maxNight;i++) row.push(r.night[i]||'');
    rows.push(row.map(v=>String(v).replaceAll('"','""')).map(v=>/[,\n"]/.test(v)?`"${v}"`:v).join(','));
  });
  const bom=new Uint8Array([0xEF,0xBB,0xBF]); return new Blob([bom, rows.join('\n')], {type:'text/csv;charset=utf-8;'});
}
function buildICS(schedule, opts={}){
  const { mode='all', staffName=null } = opts; const tz='Asia/Tokyo';
  const now=new Date(); const dtstamp=now.toISOString().replace(/[-:]/g,'').replace(/\..+/, 'Z'); const EOL='\r\n';
  const pad2=n=>String(n).padStart(2,'0');
  function dtLocal(dateStr,hhmm){ const [Y,M,D]=dateStr.split('-').map(Number); const [hh,mm]=hhmm.split(':').map(Number); return `${Y}${pad2(M)}${pad2(D)}T${pad2(hh)}${pad2(mm)}00`; }
  function plusOneDay(dateStr){ const d=new Date(dateStr+'T00:00:00'); return fmtDate(addDays(d,1)); }
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//ShiftCrafter//Monthly//JP','CALSCALE:GREGORIAN'];
  schedule.forEach(r=>{
    const date=r.date; const evs=[];
    r.day.forEach(name=>{ if(mode==='staff'&&name!==staffName) return; evs.push({ summary:`日勤：${name}`, start:dtLocal(date,'09:00'), end:dtLocal(date,'17:00'), uid:`${date}-day-${encodeURIComponent(name)}` }); });
    r.night.forEach(name=>{ if(mode==='staff'&&name!==staffName) return; const next=plusOneDay(date); evs.push({ summary:`夜勤：${name}`, start:dtLocal(date,'17:00'), end:dtLocal(next,'09:00'), uid:`${date}-night-${encodeURIComponent(name)}` }); });
    evs.forEach(ev=>{ lines.push('BEGIN:VEVENT', `UID:${ev.uid}@shiftcrafter`, `DTSTAMP:${dtstamp}`, `DTSTART;TZID=${tz}:${ev.start}`, `DTEND;TZID=${tz}:${ev.end}`, `SUMMARY:${ev.summary}`, 'END:VEVENT'); });
  });
  lines.push('END:VCALENDAR'); return new Blob([lines.join(EOL)], {type:'text/calendar;charset=utf-8;'});
}
function renderTable(schedule){
  if(!schedule.length){ document.getElementById('tableWrap').textContent='未作成'; return; }
  let maxDay=0, maxNight=0; schedule.forEach(r=>{ maxDay=Math.max(maxDay,r.day.length); maxNight=Math.max(maxNight,r.night.length); });
  let html='<table><thead><tr><th>date</th><th>dow</th><th>need_day</th><th>need_night</th>';
  for(let i=1;i<=maxDay;i++) html+=`<th>day_staff_${i}</th>`; for(let i=1;i<=maxNight;i++) html+=`<th>night_staff_${i}</th>`; html+='</tr></thead><tbody>';
  schedule.forEach(r=>{
    html+='<tr>'+`<td>${r.date}</td><td>${r.dow}</td><td>${r.needDay}</td><td>${r.needNight}</td>`;
    for(let i=0;i<maxDay;i++) html+=`<td>${r.day[i]||''}</td>`; for(let i=0;i<maxNight;i++) html+=`<td>${r.night[i]||''}</td>`;
    html+='</tr>';
  }); html+='</tbody></table>'; document.getElementById('tableWrap').innerHTML=html;
}
function renderSummary(schedule, staff){
  const byStaff=Object.fromEntries(staff.map(s=>[s,{total:0,night:0}])); let consecViolations=0;
  for(let i=0;i<schedule.length;i++){
    const r=schedule[i]; r.day.forEach(n=>{ byStaff[n].total++; }); r.night.forEach(n=>{ byStaff[n].total++; byStaff[n].night++; });
    if(i>0){ const prev=schedule[i-1]; const setPrevNight=new Set(prev.night); r.night.forEach(n=>{ if(setPrevNight.has(n)) consecViolations++; }); }
  }
  const rows=[['staff','total','night']]; Object.entries(byStaff).forEach(([name,st])=>rows.push([name,st.total,st.night]));
  const text=rows.map(r=>r.join('\t')).join('\n'); document.getElementById('summary').textContent = text + (consecViolations? `\n注意: 連続夜勤（2連以上）検出 ${consecViolations} 件` : '\nOK: 連続夜勤違反なし');
}

// ====== DOM参照 ======
const elMonth = document.getElementById('month');
const elNeedDay = document.getElementById('needDay');
const elNeedNight = document.getElementById('needNight');
const elWCap = document.getElementById('weeklyNightCap');
const elMCap = document.getElementById('monthlyNightCap');
const elBtnGen = document.getElementById('btnGen');
const elBtnCsv = document.getElementById('btnCsv');
const elBtnIcsAll = document.getElementById('btnIcsAll');
const elBtnValidate = document.getElementById('btnValidate');
const elMsg = document.getElementById('msg');

let lastSchedule = null;

// ====== 検証CSV作成関数 ======
function buildValidationCSV(schedule, staff, requests, weeklyNightCap, monthlyNightCap){
  const rows=[['staff','total','night','consec_night_2plus','day_after_night_violation','requested_off_days','satisfied_off_days','off_fulfillment_pct','weekly_night_cap','weekly_night_cap_violations','monthly_night_cap','monthly_night_cap_violation','required_slots_filled_pct']];
  let requiredTotal=0, filledTotal=0; schedule.forEach(r=>{ requiredTotal+=(r.needDay||0)+(r.needNight||0); filledTotal+=(r.day?.length||0)+(r.night?.length||0); });
  const requiredFilledPct = requiredTotal ? Math.round(1000*filledTotal/requiredTotal)/10 : 100.0;

  const isoWeek=d=>{ const dt=new Date(d+'T00:00:00'); const date=new Date(Date.UTC(dt.getFullYear(), dt.getMonth(), dt.getDate())); const dayNum=(date.getUTCDay()+6)%7; date.setUTCDate(date.getUTCDate()-dayNum+3); const firstThu=new Date(Date.UTC(date.getUTCFullYear(),0,4)); const week=1+Math.round(((date-firstThu)/86400000-3+((firstThu.getUTCDay()+6)%7))/7); return `${date.getUTCFullYear()}-W${String(week).padStart(2,'0')}`; };

  const per=Object.fromEntries(staff.map(s=>[s,{total:0,night:0,consecNight:0,dayAfterNight:0,reqDays:0,offSatisfied:0,nightByWeek:{},monthlyNight:0}]));
  for(let i=0;i<schedule.length;i++){
    const curr=schedule[i], prev=schedule[i-1]||null; const prevNight=new Set(prev?.night||[]); const wk=isoWeek(curr.date);
    curr.day.forEach(n=>{ per[n].total++; });
    curr.night.forEach(n=>{ per[n].total++; per[n].night++; per[n].monthlyNight++; per[n].nightByWeek[wk]=(per[n].nightByWeek[wk]||0)+1; if(prevNight.has(n)) per[n].consecNight++; });
    if(prev){ curr.day.forEach(n=>{ if(prevNight.has(n)) per[n].dayAfterNight++; }); }
    const reqSet=requests[curr.date]||new Set(); staff.forEach(n=>{ if(reqSet.has(n)){ per[n].reqDays++; const assigned=curr.day.includes(n)||curr.night.includes(n); if(!assigned) per[n].offSatisfied++; }});
  }
  staff.forEach(n=>{
    const p=per[n]; const offPct=p.reqDays?Math.round(1000*p.offSatisfied/p.reqDays)/10:100.0;
    let wkViol=0; if(weeklyNightCap!=='' && weeklyNightCap!=null){ const cap=Number(weeklyNightCap)||0; Object.values(p.nightByWeek).forEach(v=>{ if(v>cap) wkViol++; }); }
    const mCap=(monthlyNightCap===''||monthlyNightCap==null)?null:Number(monthlyNightCap)||0; const mViol=(mCap!=null)?(p.monthlyNight>mCap?1:0):0;
    rows.push([n,p.total,p.night,p.consecNight,p.dayAfterNight,p.reqDays,p.offSatisfied,offPct,(weeklyNightCap===''?'-':weeklyNightCap),wkViol,(mCap==null?'-':mCap),mViol,requiredFilledPct]);
  });
  const bom=new Uint8Array([0xEF,0xBB,0xBF]); const csv=rows.map(r=>r.map(v=>String(v).replaceAll('"','""')).map(v=>/[",\n]/.test(v)?`"${v}"`:v).join(',')).join('\n');
  return new Blob([bom,csv],{type:'text/csv;charset=utf-8;'});
}

// ====== イベント ======
elBtnGen.addEventListener('click', ()=>{
  const monthStart = parseMonthStr(elMonth.value);
  const staff = getStaff();
  const requests = getRequests();
  const needDay = Number(elNeedDay.value||0);
  const needNight = Number(elNeedNight.value||0);
  const weeklyNightCap = Number(elWCap.value||0);
  const monthlyNightCap = elMCap.value === '' ? '' : Number(elMCap.value||0);

  if(!monthStart){ elMsg.innerHTML = '<span class="error">対象月を入力してください</span>'; return; }
  if(staff.length===0){ elMsg.innerHTML = '<span class="error">職員リストが空です</span>'; return; }
  if(needDay+needNight===0){ elMsg.innerHTML = '<span class="warn">必要人数が0です。結果は空割当になります</span>'; }

  const { schedule } = assignMonthly({ monthStart, needDay, needNight, weeklyNightCap, monthlyNightCap, staff, requests });
  lastSchedule = schedule;

  renderTable(schedule);
  renderSummary(schedule, staff);

  // 生成成功後にボタンを有効化
  elBtnCsv.disabled = false;
  elBtnIcsAll.disabled = false;
  elBtnValidate.disabled = false;

  elMsg.innerHTML = '<span class="ok">作成完了。CSV/ICS/検証CSVのダウンロードが可能です</span>';
});

// CSVダウンロード
elBtnCsv.addEventListener('click', ()=>{
  if(!lastSchedule) return;
  download('schedule_monthly.csv', toCSVWide(lastSchedule));
});

// ICS（全体）ダウンロード
elBtnIcsAll.addEventListener('click', ()=>{
  if(!lastSchedule) return;
  download('shift_monthly_all.ics', buildICS(lastSchedule, {mode:'all'}));
});

// 検証CSVダウンロード
elBtnValidate.addEventListener('click', ()=>{
  if(!lastSchedule) return;
  const staff = getStaff();
  const req = getRequests();
  const blob = buildValidationCSV(
    lastSchedule, staff, req,
    document.getElementById('weeklyNightCap').value,
    document.getElementById('monthlyNightCap').value
  );
  download('validation_summary.csv', blob);
});

// 既定：今月を初期表示
(function init(){
  const now=new Date(); const ym=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  elMonth.value=ym;
})();
</script>
</body>
</html>
